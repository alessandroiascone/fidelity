<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong ‚Ä¢ Scadenzario v31 (Acquisizione + Reminder + Fidelity)</title>
  <meta name="theme-color" content="#0a0a0a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#0b0d12; --bg2:#06070b;
      --card:rgba(14,16,22,.92); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.70);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff;
      --ok:#25D366; --danger:#ff4d4f;
    }
    body{
      min-height:100svh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Inter",Roboto,sans-serif;
      color:#e8edff;
      background:
        radial-gradient(80% 80% at 0% 0%,rgba(10,162,255,.18),transparent),
        radial-gradient(70% 80% at 100% 0%,rgba(0,255,200,.18),transparent),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      padding:16px;
    }
    .app{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    h1{
      font-size:22px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#f9fbff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    h1 span.sub{
      font-size:11px;
      text-transform:none;
      letter-spacing:.04em;
      font-weight:500;
      color:var(--muted);
    }
    .badge-pill{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      padding:4px 9px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(0,0,0,.6);
    }
    .badge-pill span.dot{
      width:7px;height:7px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#0f0,transparent);
      box-shadow:0 0 10px rgba(0,255,0,.7);
    }

    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.3fr);
      gap:14px;
      align-items:flex-start;
    }
    @media (max-width:900px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:var(--card);
      border-radius:18px;
      border:1px solid var(--stroke);
      padding:12px 14px 14px;
      box-shadow:0 18px 40px rgba(0,0,0,.65);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-30%;
      background:
        radial-gradient(circle at 0 0,rgba(10,162,255,.18),transparent 60%),
        radial-gradient(circle at 100% 0,rgba(0,255,200,.12),transparent 60%);
      opacity:.6;
      pointer-events:none;
    }
    .card-inner{position:relative;z-index:1}

    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:10px;
    }
    .card-header h2{
      font-size:15px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:#f7f8ff;
    }
    .card-header small{
      font-size:11px;
      color:var(--muted);
    }

    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .pill{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      padding:4px 9px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      background:rgba(0,0,0,.5);
      color:var(--muted);
      transition:all .18s ease;
    }
    .pill span.dot{
      width:7px;height:7px;border-radius:999px;
      background:rgba(255,255,255,.4);
    }
    .pill.active{
      color:#fff;
      border-color:var(--elec2);
      background:radial-gradient(circle at 0 0,rgba(10,162,255,.30),rgba(4,7,15,1));
      box-shadow:0 0 18px rgba(10,162,255,.7);
    }
    .pill.active span.dot{
      background:radial-gradient(circle at 30% 30%,#0af,transparent);
    }
    .pill.danger{
      border-color:rgba(255,77,79,.8);
      color:#ffd7d7;
    }

    .grid-two{
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,1.2fr);
      gap:8px;
      margin-top:8px;
      align-items:flex-start;
    }
    @media (max-width:700px){
      .grid-two{
        grid-template-columns:1fr;
      }
    }

    label{
      font-size:11px;
      color:var(--muted);
      margin-bottom:2px;
      display:block;
    }
    input,select,textarea{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(3,6,14,.9);
      color:#f9fbff;
      font-size:13px;
      padding:7px 10px;
      outline:none;
      transition:border-color .18s ease,box-shadow .18s ease,background .18s ease;
      font-family:inherit;
    }
    textarea{
      border-radius:12px;
      min-height:60px;
      resize:vertical;
      padding:7px 10px;
    }
    input::placeholder,textarea::placeholder{
      color:rgba(180,190,230,.6);
      font-size:12px;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--elec2);
      box-shadow:0 0 0 1px rgba(10,162,255,.6);
      background:rgba(5,9,18,.95);
    }

    .row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .row > *{flex:1 1 0}

    .btn{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      padding:7px 12px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      background:rgba(0,0,0,.7);
      color:#f7f9ff;
      display:inline-flex;
      align-items:center;
      gap:6px;
      justify-content:center;
      transition:all .18s ease;
      white-space:nowrap;
    }
    .btn span.icon{font-size:15px}
    .btn-primary{
      border-color:var(--elec3);
      background:linear-gradient(135deg,var(--elec),var(--elec2));
      color:#021018;
      box-shadow:0 12px 30px rgba(0,0,0,.7),0 0 18px rgba(10,162,255,.7);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 36px rgba(0,0,0,.9),0 0 22px rgba(10,162,255,.9);
    }
    .btn-ghost{
      background:transparent;
      color:var(--muted);
    }
    .btn-ghost:hover{
      background:rgba(255,255,255,.04);
    }

    .tags-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .tag{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      padding:3px 8px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .tag.hot{
      border-color:var(--elec);
      color:#e6f6ff;
      background:radial-gradient(circle at 0 0,rgba(10,162,255,.32),rgba(4,7,15,1));
    }

    .list-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }
    .search-input{
      position:relative;
      flex:1 1 0;
    }
    .search-input input{
      padding-left:26px;
    }
    .search-input span.icon{
      position:absolute;
      left:9px;
      top:50%;
      transform:translateY(-50%);
      font-size:12px;
      color:var(--muted);
    }

    .filter-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .filter-pill{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      padding:3px 9px;
      font-size:11px;
      cursor:pointer;
      color:var(--muted);
      background:rgba(0,0,0,.5);
    }
    .filter-pill.active{
      border-color:var(--elec2);
      color:#e6f6ff;
      background:radial-gradient(circle at 0 0,rgba(10,162,255,.28),rgba(4,7,15,1));
      box-shadow:0 0 12px rgba(10,162,255,.7);
    }

    .table-wrap{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(1,4,12,.98);
      overflow:hidden;
      max-height:420px;
      display:flex;
      flex-direction:column;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    thead{
      background:linear-gradient(90deg,rgba(10,162,255,.16),rgba(0,0,0,.9));
    }
    th,td{
      padding:6px 8px;
      text-align:left;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    th{
      font-weight:600;
      color:#f5f7ff;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody{
      display:block;
      overflow:auto;
      max-height:360px;
    }
    thead,tr{
      display:table;
      width:100%;
      table-layout:fixed;
    }
    tr:nth-child(even) td{
      background:rgba(255,255,255,.01);
    }
    tr:hover td{
      background:rgba(10,162,255,.08);
    }

    .status-pill{
      border-radius:999px;
      padding:2px 7px;
      font-size:10px;
      border:1px solid rgba(255,255,255,.16);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .status-pill.ok{
      border-color:rgba(0,200,120,.9);
      color:#b7ffdd;
      background:rgba(0,200,120,.18);
    }
    .status-pill.warn{
      border-color:rgba(255,200,0,.9);
      color:#fff4c2;
      background:rgba(255,200,0,.12);
    }
    .status-pill.danger{
      border-color:rgba(255,77,79,.9);
      color:#ffd5d7;
      background:rgba(255,77,79,.14);
    }

    .whats-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      border-radius:999px;
      border:1px solid rgba(37,211,102,.7);
      padding:2px 7px;
      font-size:10px;
      color:#d3ffe5;
      background:rgba(0,0,0,.8);
      text-decoration:none;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.9);
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      padding:7px 14px;
      color:#f7f9ff;
      font-size:12px;
      z-index:9999;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .small{
      font-size:11px;
      color:var(--muted);
    }

    .counter-pill{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      padding:3px 8px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      color:var(--muted);
    }

    .sync-pill{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      padding:3px 8px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      background:rgba(0,0,0,.6);
    }
    .sync-pill span.dot{
      width:7px;height:7px;border-radius:999px;
      background:rgba(255,255,255,.4);
    }
    .sync-pill.active span.dot{
      background:radial-gradient(circle at 30% 30%,#0f0,transparent);
      box-shadow:0 0 10px rgba(0,255,0,.8);
    }

    .pill-group-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
      margin-bottom:4px;
    }

    .section-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }

    .fidelity-pill{
      border-radius:999px;
      border:1px solid rgba(255,215,0,.8);
      padding:4px 8px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:linear-gradient(135deg,rgba(255,215,0,.25),rgba(0,0,0,.9));
      color:#fff7d1;
    }
    .fidelity-pill span.icon{font-size:14px}

    .points-pill{
      border-radius:999px;
      border:1px solid rgba(0,140,255,.6);
      padding:3px 8px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      background:linear-gradient(135deg,rgba(0,140,255,.28),rgba(0,0,0,.9));
      color:#def1ff;
    }

    .pill-toggle-group{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .pill-toggle{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      padding:3px 7px;
      font-size:11px;
      cursor:pointer;
      color:var(--muted);
      background:rgba(0,0,0,.5);
    }
    .pill-toggle.on{
      border-color:var(--elec2);
      color:#e8f5ff;
      background:radial-gradient(circle at 0 0,rgba(10,162,255,.30),rgba(4,7,15,1));
      box-shadow:0 0 16px rgba(10,162,255,.7);
    }

    .link-mini{
      font-size:11px;
      color:var(--elec2);
      text-decoration:none;
    }
    .link-mini:hover{text-decoration:underline;}

  </style>
</head>
<body>
  <div class="app">
    <header style="margin-bottom:4px;">
      <h1>
        <span>ReLong ‚Ä¢ Scadenzario v31</span>
        <span class="sub">Acquisizione clienti, reminder WhatsApp & Fidelity Card</span>
      </h1>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:4px;flex-wrap:wrap;">
        <div class="badge-pill">
          <span class="dot"></span>
          <span>Motore Remind attivo ‚Ä¢ WhatsApp ‚Ä¢ Energia ‚Ä¢ Telefonia ‚Ä¢ Fidelity</span>
        </div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
          <div id="counterPill" class="counter-pill">
            üë• Clienti: <strong id="clientsCount">0</strong>
          </div>
          <button id="backupBtn" class="btn btn-ghost" type="button">
            <span class="icon">üíæ</span>
            Backup lista clienti
          </button>
        </div>
      </div>
    </header>

    <div class="layout">
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <h2>Nuovo cliente</h2>
              <small>Acquisizione con reminder automatici e Fidelity</small>
            </div>
            <div class="fidelity-pill">
              <span class="icon">‚≠ê</span>
              <span>Fidelity Card auto-assegnata</span>
            </div>
          </div>

          <div class="grid-two">
            <div>
              <label for="name">Nome e Cognome</label>
              <input id="name" type="text" placeholder="Es. Mario Rossi" autocomplete="off" />
            </div>
            <div>
              <label for="phone">Telefono (WhatsApp)</label>
              <input id="phone" type="tel" placeholder="Es. 3331234567" autocomplete="off" />
            </div>
          </div>

          <div style="margin-top:8px;">
            <div class="pill-group-title">Servizi attivati oggi</div>
            <div class="pill-row" id="activatedPills">
              <button class="pill" data-key="sim" type="button">
                <span class="dot"></span><span>SIM mobile</span>
              </button>
              <button class="pill" data-key="fissomobile" type="button">
                <span class="dot"></span><span>Fisso + Mobile</span>
              </button>
              <button class="pill" data-key="energia" type="button">
                <span class="dot"></span><span>Energia (luce & gas)</span>
              </button>
              <button class="pill" data-key="rate" type="button">
                <span class="dot"></span><span>Smartphone a rate</span>
              </button>
              <button class="pill" data-key="pacchi" type="button">
                <span class="dot"></span><span>Pacchi / Spedizioni</span>
              </button>
              <button class="pill" data-key="riparazione" type="button">
                <span class="dot"></span><span>Riparazione PC / Smartphone</span>
              </button>
            </div>
          </div>

          <div class="grid-two" style="margin-top:8px;">
            <div>
              <label>Accettazione contatto</label>
              <div class="pill-row">
                <button class="pill" id="accSi" type="button">
                  <span class="dot"></span><span>Consenso WhatsApp ‚úî</span>
                </button>
                <button class="pill danger" id="accNo" type="button">
                  <span class="dot"></span><span>Nessun consenso</span>
                </button>
              </div>
            </div>
            <div>
              <label>Origine cliente</label>
              <select id="origin">
                <option value="negozio" selected>In negozio</option>
                <option value="pacchi">Dal servizio pacchi</option>
                <option value="referral">Presentato da amico</option>
                <option value="social">Social / Online</option>
              </select>
            </div>
          </div>

          <div style="margin-top:8px;">
            <label for="notes">Note / Esigenze</label>
            <textarea id="notes" placeholder="Inserisci dettagli su esigenze, promo proposte, preferenze per smartphone, energia o altro."></textarea>
          </div>

          <div class="grid-two" style="margin-top:8px;">
            <div>
              <label>Stato riparazione (se presente)</label>
              <select id="repairStatus">
                <option value="">Nessuna riparazione</option>
                <option value="diagnostica">In diagnostica</option>
                <option value="in-corso">In riparazione</option>
                <option value="pronto">Pronto per ritiro</option>
                <option value="consegnato">Consegnato</option>
              </select>
            </div>
            <div>
              <label>Preventivo riparazione</label>
              <div class="row">
                <select id="quoteStatus">
                  <option value="">Nessun preventivo</option>
                  <option value="proposed">Proposto</option>
                  <option value="accepted">Accettato</option>
                  <option value="rejected">Rifiutato</option>
                </select>
                <input id="quotePrice" type="number" min="0" step="1" placeholder="‚Ç¨" />
              </div>
            </div>
          </div>

          <div style="margin-top:8px;">
            <div class="section-title-row">
              <div class="pill-group-title">Radar servizi (remind futuri)</div>
              <div class="small">Questi servizi NON sono attivi ma vanno ricordati.</div>
            </div>
            <div class="pill-toggle-group" id="radarPills">
              <button class="pill-toggle" data-key="sim" type="button">SIM</button>
              <button class="pill-toggle" data-key="fissomobile" type="button">Fisso+Mobile</button>
              <button class="pill-toggle" data-key="energia" type="button">Energia</button>
              <button class="pill-toggle" data-key="rate" type="button">Rate smartphone</button>
            </div>
          </div>

          <div style="margin-top:10px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
            <div class="tags-row">
              <span class="tag hot">Remind WhatsApp + Fidelity automatica</span>
              <span class="tag">Pacchi ‚Ä¢ Energia ‚Ä¢ Telefonia</span>
            </div>
            <button id="addBtn" class="btn btn-primary" type="button">
              <span class="icon">‚ûï</span>
              <span>Registra cliente e genera Fidelity</span>
            </button>
          </div>

          <div style="margin-top:6px;" class="small">
            Alla registrazione:
            <ul style="margin-left:14px;margin-top:2px;list-style:disc;">
              <li>Viene generata una Fidelity Card con ID univoco</li>
              <li>Assegniamo <strong>+20 punti di benvenuto</strong> in automatico</li>
              <li>Impostiamo il ciclo di remind WhatsApp su SIM, fisso, energia e rate</li>
            </ul>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <h2>Clienti & reminder</h2>
              <small>Ricerca, filtri e link rapidi a Fidelity & WhatsApp</small>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
              <div id="syncPill" class="sync-pill">
                <span class="dot"></span>
                <span id="syncLabel">Sync GitHub disattivato</span>
              </div>
              <button id="syncCfgBtn" class="btn btn-ghost" type="button">
                <span class="icon">‚öôÔ∏è</span>
                Configura Sync
              </button>
              <button id="syncNowBtn" class="btn btn-ghost" type="button">
                <span class="icon">‚§¥Ô∏è</span>
                Salva ora
              </button>
            </div>
          </div>

          <div class="list-header">
            <div class="search-input">
              <span class="icon">üîç</span>
              <input id="search" type="text" placeholder="Cerca per nome, telefono o note..." />
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
              <select id="remindFilter" style="max-width:160px;">
                <option value="">Tutti i reminder</option>
                <option value="sim">SIM</option>
                <option value="fissomobile">Fisso+Mobile</option>
                <option value="energia">Energia</option>
                <option value="rate">Rate smartphone</option>
              </select>
            </div>
          </div>

          <div class="filter-row">
            <button class="filter-pill active" data-filter="tutti" type="button">Tutti</button>
            <button class="filter-pill" data-filter="aperti" type="button">Aperti</button>
            <button class="filter-pill" data-filter="riparazioni" type="button">Riparazioni</button>
            <button class="filter-pill" data-filter="pacchi" type="button">Da pacchi</button>
            <button class="filter-pill" data-filter="fidelity" type="button">Fidelity attiva</button>
          </div>

          <div class="table-wrap" style="margin-top:8px;">
            <table>
              <thead>
                <tr>
                  <th style="width:26%;">Cliente</th>
                  <th style="width:18%;">Servizi</th>
                  <th style="width:20%;">Reminder</th>
                  <th style="width:14%;">Punti</th>
                  <th style="width:22%;">Azioni</th>
                </tr>
              </thead>
              <tbody id="tbody">
              </tbody>
            </table>
          </div>

          <div style="margin-top:6px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
            <div class="small">
              Clicca su <strong>WhatsApp</strong> per aprire il messaggio precompilato in base al reminder.
              Apri la <strong>Fidelity</strong> per mostrare punti, premi e missioni al cliente.
            </div>
            <a href="https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html" class="link-mini" target="_blank" rel="noopener">
              üîó Vai all'Hub Re Long
            </a>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const STORAGE_KEY='relong-scadenzario-v31';
    const GH_CFG_KEY='relong-gh-config-v31', GH_TOKEN_KEY='relong-gh-token-v31';
    const FIDELITY_URL='https://alessandroiascone.github.io/fidelity/fidelity.html';
    const MAPS_URL='https://maps.app.goo.gl/s4ytGUBeGYUMnffd7';
    const WHATS_BASE='https://wa.me/';

    const nameInput=document.getElementById('name');
    const phoneInput=document.getElementById('phone');
    const notesInput=document.getElementById('notes');
    const originSelect=document.getElementById('origin');
    const repairStatusSelect=document.getElementById('repairStatus');
    const quoteStatusSelect=document.getElementById('quoteStatus');
    const quotePriceInput=document.getElementById('quotePrice');

    const activatedPills=document.getElementById('activatedPills');
    const radarPills=document.getElementById('radarPills');
    const accSi=document.getElementById('accSi');
    const accNo=document.getElementById('accNo');
    const addBtn=document.getElementById('addBtn');
    const tbody=document.getElementById('tbody');
    const searchInput=document.getElementById('search');
    const filterPills=document.querySelectorAll('.filter-pill');
    const remindFilter=document.getElementById('remindFilter');
    const clientsCount=document.getElementById('clientsCount');
    const backupBtn=document.getElementById('backupBtn');

    const syncPill=document.getElementById('syncPill');
    const syncLabel=document.getElementById('syncLabel');
    const syncCfgBtn=document.getElementById('syncCfgBtn');
    const syncNowBtn=document.getElementById('syncNowBtn');

    let items=[];
    let filterState='tutti';
    let acceptContact=null;
    let ghCfg=null;
    let syncing=false;

    function loadFromStorage(){
      try{
        const raw=localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        const parsed=JSON.parse(raw);
        return Array.isArray(parsed)?parsed:[];
      }catch(e){
        console.error(e);
        return [];
      }
    }
    function saveToStorage(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      updateCounter();
    }

    function showToast(msg){
      const t=document.createElement('div');
      t.className='toast';
      t.innerHTML=`<span>‚ö°</span><span>${msg}</span>`;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),2300);
    }

    function genId(){
      return Date.now().toString(16)+Math.random().toString(16).slice(2,10);
    }

    function basePointsForServices(activated){
      let pts=0;
      if(activated.includes('sim')) pts+=30;
      if(activated.includes('fissomobile')) pts+=80;
      if(activated.includes('energia')) pts+=100;
      if(activated.includes('rate')) pts+=60;
      if(activated.includes('pacchi')) pts+=20;
      if(activated.includes('riparazione')) pts+=50;
      return pts;
    }

    function initialReminders(activated, radar){
      const now=Date.now();
      const addDays=(d)=>new Date(now+d*24*60*60*1000).toISOString();
      const out=[];
      const allKeys=new Set([...activated,...radar]);
      if(allKeys.has('sim')) out.push({type:'sim',dueAt:addDays(7),sent:false,sentAt:null});
      if(allKeys.has('fissomobile')) out.push({type:'fissomobile',dueAt:addDays(14),sent:false,sentAt:null});
      if(allKeys.has('energia')) out.push({type:'energia',dueAt:addDays(21),sent:false,sentAt:null});
      if(allKeys.has('rate')) out.push({type:'rate',dueAt:addDays(10),sent:false,sentAt:null});
      return out;
    }

    function createFidelityBasePoints(item){
      const welcome=20;
      const servicesBase=basePointsForServices(item.activated||[]);
      let total=welcome+servicesBase;
      const movements=[];
      movements.push({
        code:'welcome-'+item.id,
        label:'Bonus di Benvenuto',
        delta:20,
        at:new Date().toISOString()
      });
      if(servicesBase>0){
        movements.push({
          code:'base-'+item.id,
          label:'Punti servizi attivati',
          delta:servicesBase,
          at:new Date().toISOString()
        });
      }
      return {total, movements};
    }

    function countPoints(item){
      const base=item.points||0;
      return base;
    }

    function buildRow(item){
      const tr=document.createElement('tr');

      const tdName=document.createElement('td');
      const statusLabel=item.done?'‚úî Cliente chiuso':'In follow-up';
      const statusCls=item.done?'ok':(item.reminders&&item.reminders.length?'warn':'danger');
      tdName.innerHTML=`
        <div style="font-weight:600;font-size:12px;">${item.name||'-'}</div>
        <div style="font-size:11px;color:var(--muted);">${item.phone||''}</div>
        <div style="margin-top:3px;">
          <span class="status-pill ${statusCls}">
            <span>${statusLabel}</span>
          </span>
          ${item.fromPacchi?'<span style="margin-left:4px;font-size:10px;color:#ffd47b;">üì¶ Da servizio pacchi</span>':''}
        </div>
      `;

      const tdServ=document.createElement('td');
      const acts=item.activated||[];
      tdServ.innerHTML=acts.length
        ? acts.map(s=>`<span class="tag" style="margin-right:2px;margin-bottom:2px;">${s}</span>`).join('')
        : '<span class="small">Nessun servizio attivo</span>';

      const tdRem=document.createElement('td');
      const rems=item.reminders||[];
      if(!rems.length){
        tdRem.innerHTML='<span class="small">Nessun remind attivo</span>';
      }else{
        const next=rems
          .filter(r=>!r.sent)
          .sort((a,b)=>new Date(a.dueAt)-new Date(b.dueAt))[0];
        if(next){
          const dt=new Date(next.dueAt);
          const label=next.type||'remind';
          tdRem.innerHTML=`
            <div style="font-size:11px;">
              <div>Prossimo: <strong>${label}</strong></div>
              <div style="color:var(--muted);">${dt.toLocaleDateString('it-IT')}</div>
            </div>
          `;
        }else{
          tdRem.innerHTML='<span class="small">Remind tutti inviati</span>';
        }
      }

      const tdPoints=document.createElement('td');
      const pts=countPoints(item);
      tdPoints.innerHTML=`
        <div class="points-pill">
          <span>‚≠ê</span><span>${pts}</span>
        </div>
      `;

      const tdActions=document.createElement('td');
      const phone=item.phone||'';
      const id=item.id;
      const fidLink=id?`${FIDELITY_URL}?id=${encodeURIComponent(id)}`:'#';

      const btnRow=document.createElement('div');
      btnRow.style.display='flex';
      btnRow.style.flexDirection='column';
      btnRow.style.gap='4px';

      const waBtn=document.createElement('a');
      waBtn.className='whats-pill';
      if(phone){
        const msg=`Ciao ${item.name||''}, sono Alessandro di Re Long.\nTi scrivo per un aggiornamento sui nostri servizi dedicati (telefonia, energia o promozioni) e sulla tua Fidelity Card.`;
        waBtn.href=`${WHATS_BASE}${encodeURIComponent(phone)}?text=${encodeURIComponent(msg)}`;
        waBtn.target='_blank';
        waBtn.rel='noopener';
      }else{
        waBtn.href='#';
      }
      waBtn.innerHTML='<span>üí¨</span><span>WhatsApp</span>';

      const fidBtn=document.createElement('a');
      fidBtn.className='whats-pill';
      fidBtn.style.borderColor='rgba(255,215,0,.8)';
      fidBtn.style.color='#fff2c4';
      fidBtn.style.marginTop='2px';
      if(id){
        fidBtn.href=fidLink;
        fidBtn.target='_blank';
        fidBtn.rel='noopener';
      }else{
        fidBtn.href='#';
      }
      fidBtn.innerHTML='<span>‚≠ê</span><span>Fidelity</span>';

      btnRow.appendChild(waBtn);
      btnRow.appendChild(fidBtn);

      tdActions.appendChild(btnRow);

      tr.appendChild(tdName);
      tr.appendChild(tdServ);
      tr.appendChild(tdRem);
      tr.appendChild(tdPoints);
      tr.appendChild(tdActions);

      return tr;
    }

    function applyFilterAndRender(){
      const term=(searchInput.value||'').toLowerCase().trim();
      const remindSel=remindFilter.value;
      tbody.innerHTML='';
      let filtered=items.slice();

      if(term){
        filtered=filtered.filter(it=>{
          const txt=[
            it.name||'',
            it.phone||'',
            it.notes||''
          ].join(' ').toLowerCase();
          return txt.includes(term);
        });
      }

      if(filterState==='aperti'){
        filtered=filtered.filter(it=>!it.done);
      }else if(filterState==='riparazioni'){
        filtered=filtered.filter(it=>(it.activated||[]).includes('riparazione'));
      }else if(filterState==='pacchi'){
        filtered=filtered.filter(it=>it.fromPacchi);
      }else if(filterState==='fidelity'){
        filtered=filtered.filter(it=>!!it.id);
      }

      if(remindSel){
        filtered=filtered.filter(it=>{
          const rems=it.reminders||[];
          return rems.some(r=>r.type===remindSel);
        });
      }

      filtered.sort((a,b)=>{
        const da=new Date(a.createdAt||0).getTime();
        const db=new Date(b.createdAt||0).getTime();
        return db-da;
      });

      filtered.forEach(it=>{
        tbody.appendChild(buildRow(it));
      });

      updateCounter(filtered.length);
    }

    function updateCounter(visibleCount){
      clientsCount.textContent=String(visibleCount!=null?visibleCount:items.length);
    }

    activatedPills.addEventListener('click',e=>{
      const btn=e.target.closest('.pill');
      if(!btn) return;
      btn.classList.toggle('active');
    });

    radarPills.addEventListener('click',e=>{
      const btn=e.target.closest('.pill-toggle');
      if(!btn) return;
      btn.classList.toggle('on');
    });

    accSi.addEventListener('click',()=>{
      acceptContact=true;
      accSi.classList.add('active');
      accNo.classList.remove('active');
      accNo.classList.remove('danger');
    });
    accNo.addEventListener('click',()=>{
      acceptContact=false;
      accNo.classList.add('active','danger');
      accSi.classList.remove('active');
    });

    addBtn.addEventListener('click',()=>{
      const name=(nameInput.value||'').trim();
      const phone=(phoneInput.value||'').trim();
      if(!name||!phone){
        showToast('Inserisci almeno nome e telefono');
        return;
      }
      if(acceptContact===null){
        showToast('Indica se il cliente accetta il contatto WhatsApp');
        return;
      }

      const acts=[];
      activatedPills.querySelectorAll('.pill.active').forEach(p=>{
        acts.push(p.getAttribute('data-key'));
      });
      const radar=[];
      radarPills.querySelectorAll('.pill-toggle.on').forEach(p=>{
        radar.push(p.getAttribute('data-key'));
      });

      const id=genId();
      const baseFid=createFidelityBasePoints({id, activated:acts});
      const nowIso=new Date().toISOString();

      const item={
        id,
        name,
        phone,
        createdAt:nowIso,
        updatedAt:nowIso,
        activated:acts,
        radar,
        acceptance:acceptContact,
        fromPacchi:originSelect.value==='pacchi',
        origin:originSelect.value,
        notes:notesInput.value||'',
        done:false,
        repairStatus:repairStatusSelect.value||'',
        quoteStatus:quoteStatusSelect.value||'',
        quotePrice:quotePriceInput.value?Number(quotePriceInput.value):null,
        reminders:initialReminders(acts,radar),
        remindersCycle:1,
        responded:false,
        points:baseFid.total,
        pointsMovements:baseFid.movements,
        acceptanceHistory:[]
      };

      items.push(item);
      saveToStorage();
      applyFilterAndRender();
      showToast('Cliente registrato + Fidelity generata ‚úÖ');

      nameInput.value='';
      phoneInput.value='';
      notesInput.value='';
      originSelect.value='negozio';
      repairStatusSelect.value='';
      quoteStatusSelect.value='';
      quotePriceInput.value='';
      acceptContact=null;
      accSi.classList.remove('active');
      accNo.classList.remove('active','danger');
      activatedPills.querySelectorAll('.pill.active').forEach(p=>p.classList.remove('active'));
      radarPills.querySelectorAll('.pill-toggle.on').forEach(p=>p.classList.remove('on'));
    });

    searchInput.addEventListener('input',applyFilterAndRender);
    remindFilter.addEventListener('change',applyFilterAndRender);

    filterPills.forEach(btn=>{
      btn.addEventListener('click',()=>{
        filterPills.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        filterState=btn.getAttribute('data-filter');
        applyFilterAndRender();
      });
    });

    backupBtn.addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify(items,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download='relong-scadenzario-backup.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('Backup clienti scaricato üíæ');
    });

    function loadGhCfg(){
      try{
        const raw=localStorage.getItem(GH_CFG_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    }
    function syncBadge(active){
      if(active){
        syncPill.classList.add('active');
        syncLabel.textContent='Sync GitHub attivo';
      }else{
        syncPill.classList.remove('active');
        syncLabel.textContent='Sync GitHub disattivato';
      }
    }

    async function saveToGitHub(showToastFlag=true){
      if(syncing) return;
      ghCfg=loadGhCfg();
      if(!ghCfg||!ghCfg.tokenStored){
        syncBadge(false);
        if(showToastFlag) showToast('Configura prima il Sync GitHub');
        return;
      }
      const token=localStorage.getItem(GH_TOKEN_KEY);
      if(!token){
        syncBadge(false);
        if(showToastFlag) showToast('Token GitHub mancante');
        return;
      }
      syncing=true;
      syncLabel.textContent='Sync in corso...';
      try{
        const {owner,repo,branch,path}=ghCfg;
        const apiUrl=`https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const getRes=await fetch(apiUrl,{
          headers:{
            'Authorization':'Bearer '+token,
            'Accept':'application/vnd.github+json'
          }
        });
        let sha=null;
        if(getRes.ok){
          const j=await getRes.json();
          sha=j.sha;
        }
        const contentB64=btoa(unescape(encodeURIComponent(JSON.stringify(items,null,2))));
        const body={
          message:'Update scadenzario items.json',
          content:contentB64,
          branch
        };
        if(sha) body.sha=sha;
        const putRes=await fetch(apiUrl,{
          method:'PUT',
          headers:{
            'Authorization':'Bearer '+token,
            'Accept':'application/vnd.github+json'
          },
          body:JSON.stringify(body)
        });
        if(!putRes.ok) throw new Error('Errore PUT GitHub');
        syncBadge(true);
        if(showToastFlag) showToast('Dati sincronizzati su GitHub ‚úÖ');
      }catch(e){
        console.error(e);
        syncBadge(false);
        if(showToastFlag) showToast('Errore nel sync GitHub');
      }finally{
        syncing=false;
        if(ghCfg&&ghCfg.tokenStored) syncLabel.textContent='Sync GitHub attivo';
        else syncLabel.textContent='Sync GitHub disattivato';
      }
    }

    syncCfgBtn.addEventListener('click', async ()=>{
      const owner=prompt('Owner GitHub','alessandroiascone')||'';
      const repo=prompt('Repository','fidelity')||'';  // nuova repo di default
      const branch=prompt('Branch','main')||'main';
      const path=prompt('Percorso file dati','data/items.json')||'data/items.json';
      const token=prompt('Token (classic, scope repo)','')||'';
      if(!owner||!repo||!token) return alert('Compila owner/repo/token');
      localStorage.setItem(GH_CFG_KEY, JSON.stringify({owner,repo,branch,path,tokenStored:true}));
      localStorage.setItem(GH_TOKEN_KEY, token);
      syncBadge(true); showToast('Sync configurato ‚úÖ');
      await saveToGitHub();
    });

    syncNowBtn.addEventListener('click',()=>saveToGitHub(true));

    function init(){
      items=loadFromStorage();
      updateCounter();
      applyFilterAndRender();
      ghCfg=loadGhCfg();
      syncBadge(!!(ghCfg&&ghCfg.tokenStored));
    }

    init();
  </script>
</body>
</html>
