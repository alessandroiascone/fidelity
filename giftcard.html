<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong ‚Ä¢ Gift Card</title>
  <meta name="theme-color" content="#0b0d12" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg0:#05060a; --bg1:#0b0d12; --bg2:#05060a;
      --card: rgba(12,14,20,.78);
      --stroke: rgba(255,255,255,.10);
      --muted: rgba(210,220,255,.70);
      --txt: #eaf2ff;

      --red:#ff1b2d;
      --orange:#ff8a00;
      --ice:#66d1ff;
      --ice2:#008cff;

      --good:#19c37d;
      --bad:#ff3b30;
      --warn:#ffcc66;
    }

    body{
      min-height:100svh;
      font-family: system-ui, -apple-system, Inter, Roboto, "Segoe UI", sans-serif;
      color: var(--txt);
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(255,27,45,.20), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(0,140,255,.22), transparent 62%),
        radial-gradient(900px 600px at 55% 95%, rgba(255,138,0,.16), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: 22px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Tech grid + noise */
    .bg-grid{
      position:fixed; inset:0; pointer-events:none; z-index:-2;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.035) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.035) 1px, transparent 1px);
      background-size: 42px 42px;
      mask-image: radial-gradient(65% 55% at 50% 35%, black 60%, transparent 100%);
      opacity:.50;
      transform: translateZ(0);
    }
    .bg-noise{
      position:fixed; inset:-40px; pointer-events:none; z-index:-1;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='280' height='280'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='280' height='280' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      opacity:.10;
      mix-blend-mode: overlay;
    }

    .wrap{
      width: min(1080px, 100%);
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      body{padding:16px}
      .wrap{grid-template-columns:1fr; gap:12px}
    }

    .panel{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 26px;
      box-shadow:
        0 22px 70px rgba(0,0,0,.55),
        0 0 0 1px rgba(0,0,0,.55) inset;
      overflow:hidden;
      position:relative;
      backdrop-filter: blur(14px);
    }

    .topbar{
      padding: 16px 16px 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background:
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:
        radial-gradient(circle at 25% 20%, rgba(255,255,255,.25), transparent 55%),
        linear-gradient(135deg, rgba(255,27,45,.95), rgba(255,138,0,.95));
      box-shadow: 0 14px 28px rgba(255,27,45,.18), 0 0 22px rgba(255,138,0,.10);
      border:1px solid rgba(255,255,255,.14);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-30%;
      background: linear-gradient(115deg, transparent 35%, rgba(255,255,255,.22) 50%, transparent 65%);
      transform: rotate(15deg);
      animation: shine 2.6s ease-in-out infinite;
    }
    @keyframes shine{
      0%{transform:translateX(-35%) rotate(15deg)}
      55%{transform:translateX(55%) rotate(15deg)}
      100%{transform:translateX(55%) rotate(15deg)}
    }
    .brand h1{
      font-size:16px; font-weight:950; letter-spacing:.2px;
      line-height:1.1;
    }
    .brand p{
      font-size:12px; color: var(--muted);
      margin-top:2px;
    }

    .chip{
      border-radius:999px;
      padding:8px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      color: var(--muted);
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .chip b{color: var(--txt)}
    .chip.good{border-color: rgba(25,195,125,.35); color: rgba(215,255,235,.86)}
    .chip.bad{border-color: rgba(255,59,48,.35); color: rgba(255,225,224,.86)}
    .chip.warn{border-color: rgba(255,204,102,.40); color: rgba(255,244,220,.92)}

    .content{
      padding: 16px;
    }

    /* Gift card hero (left) */
    .hero{
      min-height: 540px;
      display:flex;
      flex-direction:column;
      gap:14px;
      position:relative;
    }

    .gift-hero{
      flex:1;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(255,27,45,.26), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(0,140,255,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      position:relative;
      overflow:hidden;
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      transform-style: preserve-3d;
    }

    .gift-hero::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        linear-gradient(115deg, transparent 25%, rgba(255,255,255,.14) 45%, transparent 70%);
      transform: translateX(-35%);
      animation: heroShine 3.1s ease-in-out infinite;
      opacity:.65;
      pointer-events:none;
    }
    @keyframes heroShine{
      0%{transform:translateX(-45%)}
      55%{transform:translateX(55%)}
      100%{transform:translateX(55%)}
    }

    .gift-head{
      padding: 18px 18px 10px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      position:relative;
      z-index:2;
    }
    .gift-head .ttl{
      display:flex; flex-direction:column; gap:6px;
    }
    .gift-head .ttl h2{
      font-size:18px; font-weight:950; letter-spacing:.25px;
      line-height:1.15;
    }
    .gift-head .ttl span{
      font-size:12px; color: var(--muted);
    }
    .pill{
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      letter-spacing:.2px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      user-select:none;
    }
    .pill .dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 14px rgba(25,195,125,.55);
    }

    .gift-body{
      padding: 0 18px 18px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      position:relative;
      z-index:2;
      align-items:end;
    }
    @media (max-width: 980px){
      .gift-body{grid-template-columns:1fr; align-items:stretch}
    }

    .balanceBox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.30);
      padding: 14px 14px 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
    }
    .balanceLabel{font-size:11px; color: var(--muted); letter-spacing:.16em; text-transform:uppercase}
    .balance{
      margin-top:8px;
      font-size: 44px;
      font-weight: 1000;
      letter-spacing: -1px;
      line-height:1.05;
    }
    .subrow{
      margin-top:8px;
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      color: var(--muted);
      font-size:12px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

    .actions{
      display:grid;
      gap:10px;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      color: var(--txt);
      border-radius: 16px;
      padding: 12px 12px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.2px;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(0,0,0,.55);
      background: rgba(0,0,0,.36);
    }
    .btn.primary{
      border:0;
      background: linear-gradient(135deg, rgba(255,27,45,.95), rgba(255,138,0,.95));
      color:#1a0b07;
      box-shadow: 0 18px 45px rgba(255,27,45,.18), 0 0 26px rgba(255,138,0,.12);
    }
    .btn.primary:hover{box-shadow: 0 22px 55px rgba(255,27,45,.22), 0 0 28px rgba(255,138,0,.14)}
    .btn .hint{font-size:12px; color: rgba(255,255,255,.80); font-weight:800}
    .btn .icon{font-size:16px}

    .barcode{
      margin-top: 12px;
      height: 46px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.30);
      overflow:hidden;
      position:relative;
    }
    .barcode::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(90deg,
          rgba(255,255,255,.0) 0 4px,
          rgba(255,255,255,.22) 4px 5px,
          rgba(255,255,255,.0) 5px 10px,
          rgba(255,255,255,.36) 10px 11px,
          rgba(255,255,255,.0) 11px 16px);
      opacity:.65;
      mask-image: linear-gradient(90deg, transparent, black 12%, black 88%, transparent);
    }
    .barcode::after{
      content:"";
      position:absolute; inset:-10%;
      background: linear-gradient(115deg, transparent 35%, rgba(255,255,255,.18) 50%, transparent 65%);
      transform: translateX(-40%);
      animation: barShine 2.8s ease-in-out infinite;
      opacity:.55;
    }
    @keyframes barShine{
      0%{transform:translateX(-45%)}
      60%{transform:translateX(55%)}
      100%{transform:translateX(55%)}
    }

    /* Decorative: gift boxes + smartphone ‚Äúphoto‚Äù as vector */
    .floaters{
      position:absolute; inset:0;
      pointer-events:none;
      z-index:1;
    }
    .floater{
      position:absolute;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,.55));
      opacity:.95;
      transform: translate3d(0,0,0);
      animation: bob 4.6s ease-in-out infinite;
    }
    .floater.b2{animation-duration: 5.4s; animation-delay: -1.2s; opacity:.85}
    .floater.b3{animation-duration: 6.2s; animation-delay: -2.0s; opacity:.78}
    @keyframes bob{
      0%,100%{transform: translateY(0) rotate(-1deg)}
      50%{transform: translateY(-8px) rotate(1deg)}
    }

    .floater.phone{
      animation-duration: 7.5s;
      opacity:.70;
      filter: drop-shadow(0 22px 34px rgba(0,0,0,.65));
    }

    .glowline{
      position:absolute; left:-18%; top:62%;
      width: 136%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(102,209,255,.55), rgba(255,138,0,.50), transparent);
      opacity:.55;
      filter: blur(.2px);
      z-index:0;
      transform: rotate(-6deg);
    }

    /* Right panel: movements */
    .side{
      min-height: 540px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .kpiRow{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .kpi{
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.30);
      padding: 12px 12px 11px;
      box-shadow: 0 18px 40px rgba(0,0,0,.42);
    }
    .kpi .k{font-size:11px; color: var(--muted); letter-spacing:.14em; text-transform:uppercase}
    .kpi .v{margin-top:6px; font-size:18px; font-weight:950}
    .kpi .v.small{font-size:14px; color: rgba(240,246,255,.92); font-weight:850}
    .kpi .v.mono{font-size:13px}
    .kpi .tag{
      margin-top:8px;
      display:inline-flex;
      gap:6px;
      align-items:center;
      font-size:12px;
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
    }
    .kpi .tag .s{width:8px;height:8px;border-radius:999px;background:var(--warn);box-shadow:0 0 14px rgba(255,204,102,.55)}
    .kpi .tag.good .s{background:var(--good); box-shadow:0 0 14px rgba(25,195,125,.55)}
    .kpi .tag.bad .s{background:var(--bad); box-shadow:0 0 14px rgba(255,59,48,.55)}

    .table{
      flex:1;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      overflow:hidden;
      box-shadow: 0 22px 60px rgba(0,0,0,.48);
    }
    .table header{
      padding: 14px 14px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
    }
    .table header h3{font-size:14px;font-weight:950;letter-spacing:.25px}
    .table header span{font-size:12px;color: var(--muted)}
    .rows{padding: 10px 10px 12px; display:grid; gap:8px}
    .row{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 10px;
      align-items:center;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.26);
    }
    .row .left{display:flex;flex-direction:column;gap:4px}
    .row .left .d{font-size:12px;color: var(--muted)}
    .row .left .t{font-size:13px;font-weight:900}
    .row .right{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
    .delta{
      font-size:14px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .delta.pos{color: rgba(215,255,235,.95)}
    .delta.neg{color: rgba(255,225,224,.95)}
    .bal{font-size:11px;color: var(--muted)}
    .empty{
      padding: 18px;
      color: var(--muted);
      line-height:1.45;
      font-size:13px;
    }

    .foot{
      padding: 12px 16px 14px;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.35;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .foot .mini{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }

    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="bg-noise"></div>

  <div class="wrap">
    <!-- LEFT: Gift Card -->
    <section class="panel hero">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>ReLong ‚Ä¢ Gift Card</h1>
            <p id="subtitle">Controlla saldo e movimenti in tempo reale.</p>
          </div>
        </div>
        <div class="chip" id="statusChip"><b>Stato:</b> Caricamento‚Ä¶</div>
      </div>

      <div class="content">
        <div class="gift-hero" id="tiltCard">
          <div class="glowline" aria-hidden="true"></div>

          <!-- Floating 3D decorations -->
          <div class="floaters" aria-hidden="true" id="floaters">
            <!-- Gift box 1 -->
            <div class="floater b1" style="left:6%; top:52%; width:120px;">
              <svg viewBox="0 0 220 220" width="100%" height="100%">
                <defs>
                  <linearGradient id="g1a" x1="0" x2="1">
                    <stop offset="0" stop-color="#ff1b2d"/>
                    <stop offset="1" stop-color="#ff8a00"/>
                  </linearGradient>
                  <linearGradient id="g1b" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0" stop-color="rgba(255,255,255,.35)"/>
                    <stop offset="1" stop-color="rgba(255,255,255,0)"/>
                  </linearGradient>
                </defs>
                <g transform="translate(12,24)">
                  <path d="M20 70 L98 30 L176 70 L98 110 Z" fill="rgba(255,255,255,.08)"/>
                  <path d="M20 70 L98 110 L98 182 L20 142 Z" fill="url(#g1a)" opacity=".95"/>
                  <path d="M176 70 L98 110 L98 182 L176 142 Z" fill="url(#g1a)" opacity=".78"/>
                  <path d="M20 70 L98 30 L176 70 L98 110 Z" fill="rgba(0,0,0,.18)"/>
                  <path d="M20 70 L98 30 L176 70 L98 110 Z" fill="url(#g1b)" opacity=".55"/>
                  <rect x="90" y="44" width="18" height="138" rx="9" fill="rgba(255,255,255,.28)"/>
                  <path d="M98 20 C82 20 78 42 98 48 C118 42 114 20 98 20Z" fill="rgba(255,255,255,.28)"/>
                  <path d="M98 20 C114 20 120 42 98 48 C86 40 84 24 98 20Z" fill="rgba(255,255,255,.18)"/>
                </g>
              </svg>
            </div>

            <!-- Gift box 2 -->
            <div class="floater b2" style="right:10%; top:48%; width:96px;">
              <svg viewBox="0 0 220 220" width="100%" height="100%">
                <defs>
                  <linearGradient id="g2a" x1="0" x2="1">
                    <stop offset="0" stop-color="#66d1ff"/>
                    <stop offset="1" stop-color="#008cff"/>
                  </linearGradient>
                </defs>
                <g transform="translate(12,28)">
                  <path d="M20 70 L98 30 L176 70 L98 110 Z" fill="rgba(255,255,255,.08)"/>
                  <path d="M20 70 L98 110 L98 182 L20 142 Z" fill="url(#g2a)" opacity=".92"/>
                  <path d="M176 70 L98 110 L98 182 L176 142 Z" fill="url(#g2a)" opacity=".72"/>
                  <rect x="90" y="42" width="18" height="140" rx="9" fill="rgba(255,255,255,.26)"/>
                  <path d="M98 16 C80 16 76 40 98 46 C120 40 116 16 98 16Z" fill="rgba(255,255,255,.22)"/>
                </g>
              </svg>
            </div>

            <!-- Phone ‚Äúphoto‚Äù -->
            <div class="floater phone b3" style="left:58%; top:22%; width:170px;">
              <svg viewBox="0 0 240 420" width="100%" height="100%">
                <defs>
                  <linearGradient id="pbg" x1="0" x2="1">
                    <stop offset="0" stop-color="rgba(255,255,255,.22)"/>
                    <stop offset="1" stop-color="rgba(255,255,255,.05)"/>
                  </linearGradient>
                  <linearGradient id="ps" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0" stop-color="rgba(255,27,45,.55)"/>
                    <stop offset="0.55" stop-color="rgba(0,140,255,.45)"/>
                    <stop offset="1" stop-color="rgba(255,138,0,.35)"/>
                  </linearGradient>
                </defs>
                <g>
                  <rect x="26" y="18" width="188" height="384" rx="38" fill="rgba(0,0,0,.55)" stroke="rgba(255,255,255,.18)" stroke-width="2"/>
                  <rect x="40" y="34" width="160" height="352" rx="30" fill="url(#ps)" opacity=".95"/>
                  <rect x="40" y="34" width="160" height="352" rx="30" fill="url(#pbg)" opacity=".35"/>
                  <circle cx="120" cy="46" r="6" fill="rgba(255,255,255,.35)"/>
                  <path d="M54 330 C92 300 142 304 186 270" stroke="rgba(255,255,255,.22)" stroke-width="8" stroke-linecap="round"/>
                  <path d="M54 330 C92 300 142 304 186 270" stroke="rgba(0,0,0,.18)" stroke-width="2" stroke-linecap="round"/>
                </g>
              </svg>
            </div>
          </div>

          <div class="gift-head">
            <div class="ttl">
              <h2 id="gcTitle">Gift Card Re Long</h2>
              <span id="gcSub">Inserisci un codice valido nel link (parametro <span class="mono">?code=</span>).</span>
            </div>
            <div class="pill" id="gcPill"><span class="dot"></span><span id="gcStatusTxt">‚Äî</span></div>
          </div>

          <div class="gift-body">
            <div class="balanceBox">
              <div class="balanceLabel">Saldo disponibile</div>
              <div class="balance" id="balance">‚Äî</div>
              <div class="subrow">
                <span class="mono" id="codeLine">CODE: ‚Äî</span>
                <span id="createdLine">‚Ä¢ Attivata: ‚Äî</span>
              </div>
              <div class="barcode" title="Codice Gift Card (visual)"></div>
            </div>

            <div class="actions">
              <a class="btn primary" id="waBtn" href="#" target="_blank" rel="noopener">
                <span><span class="icon">üí¨</span> Contatta Re Long</span>
                <span class="hint">WhatsApp</span>
              </a>
              <button class="btn" id="copyBtn" type="button">
                <span><span class="icon">üìã</span> Copia codice</span>
                <span class="hint mono" id="copyHint">‚Äî</span>
              </button>
              <button class="btn" id="copyLinkBtn" type="button">
                <span><span class="icon">üîó</span> Copia link Gift Card</span>
                <span class="hint">con saldo</span>
              </button>
            </div>
          </div>

        </div>
      </div>
</div>
    </section>

    <!-- RIGHT: Movements -->
    <aside class="panel side">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true" style="background: radial-gradient(circle at 25% 20%, rgba(255,255,255,.25), transparent 55%), linear-gradient(135deg, rgba(0,140,255,.95), rgba(102,209,255,.95)); box-shadow: 0 14px 28px rgba(0,140,255,.18), 0 0 22px rgba(102,209,255,.10)"></div>
          <div>
            <h1>Movimenti</h1>
            <p>Tracciamento chiaro, stile ‚Äúestratto conto‚Äù.</p>
          </div>
        </div>
        <div class="chip" id="movChip"><b>Totale:</b> ‚Äî</div>
      </div>

      <div class="content">
        <div class="kpiRow">
          <div class="kpi">
            <div class="k">Valore iniziale</div>
            <div class="v" id="initValue">‚Äî</div>
            <div class="tag" id="tagStatus"><span class="s"></span><span id="tagTxt">‚Äî</span></div>
          </div>
          <div class="kpi">
            <div class="k">Cliente associato</div>
            <div class="v small" id="custName">‚Äî</div>
            <div class="v mono" id="custPhone">‚Äî</div>
          </div>
        </div>

        <div class="table">
          <header>
            <h3>Lista movimenti</h3>
            <span id="rowsHint">‚Äî</span>
          </header>
          <div class="rows" id="rows"></div>
          <div class="empty" id="empty" style="display:none">
            Nessun movimento registrato.\n\nSe hai appena ricevuto la Gift Card, il saldo √® gi√† valido: i movimenti compariranno al primo utilizzo.
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
  (()=> {
    const RELONG_PHONE = '08119578844';

    const $ = (s)=>document.querySelector(s);

    // UI refs
    const subtitle = $('#subtitle');
    const statusChip = $('#statusChip');
    const gcStatusTxt = $('#gcStatusTxt');
    const gcSub = $('#gcSub');
    const balance = $('#balance');
    const codeLine = $('#codeLine');
    const createdLine = $('#createdLine');
    const initValue = $('#initValue');
    const custName = $('#custName');
    const custPhone = $('#custPhone');
    const rows = $('#rows');
    const empty = $('#empty');
    const rowsHint = $('#rowsHint');
    const movChip = $('#movChip');
    const waBtn = $('#waBtn');
    const copyBtn = $('#copyBtn');
    const copyHint = $('#copyHint');
    const copyLinkBtn = $('#copyLinkBtn');
    const tagStatus = $('#tagStatus');
    const tagTxt = $('#tagTxt');

    // Tilt (desktop only)
    const tiltCard = $('#tiltCard');
    function setupTilt(){}
function money(v){
      const n = Number(v||0);
      return (Number.isFinite(n)? n : 0).toLocaleString('it-IT', {style:'currency', currency:'EUR'});
    }
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleDateString('it-IT', {year:'numeric',month:'2-digit',day:'2-digit'});
      }catch(e){
        return '‚Äî';
      }
    }
    function walink(text){
      return `https://wa.me/39${RELONG_PHONE}?text=${encodeURIComponent(text)}`;
    }

    function setChipState(type, text){
      statusChip.className = 'chip ' + (type||'');
      statusChip.innerHTML = `<b>Stato:</b> ${text}`;
      const pillDot = $('#gcPill .dot');
      if(pillDot){
        pillDot.style.background = (type==='good') ? 'var(--good)' : (type==='bad' ? 'var(--bad)' : 'var(--warn)');
        pillDot.style.boxShadow = (type==='good') ? '0 0 14px rgba(25,195,125,.55)' : (type==='bad' ? '0 0 14px rgba(255,59,48,.55)' : '0 0 14px rgba(255,204,102,.55)');
      }
    }

    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || '';
    }

    const code = (getParam('code') || '').trim();
    const owner  = (getParam('owner')  || 'alessandroiascone').trim();
    const repo   = (getParam('repo')   || 'fidelity').trim();
    const branch = (getParam('branch') || 'main').trim();
    const path   = (getParam('path')   || 'data/items.json').trim();

    const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;

    copyHint.textContent = code ? code : '‚Äî';

    // Buttons base
    waBtn.href = walink(`Ciao, vorrei assistenza per una Gift Card Re Long. Codice: ${code || '(non inserito)'}`);
    copyBtn.disabled = !code;
    copyLinkBtn.disabled = !code;

    async function copyText(t){
      try{
        await navigator.clipboard.writeText(t);
        return true;
      }catch(e){
        return false;
      }
    }

    copyBtn.addEventListener('click', async ()=>{
      if(!code) return;
      const ok = await copyText(code);
      copyBtn.querySelector('.hint').textContent = ok ? 'copiato ‚úÖ' : 'seleziona manualmente';
      setTimeout(()=> copyBtn.querySelector('.hint').textContent = '‚Äî', 1600);
    });

    copyLinkBtn.addEventListener('click', async ()=>{
      if(!code) return;
      const link = `${location.origin}${location.pathname}?code=${encodeURIComponent(code)}`;
      const ok = await copyText(link);
      copyLinkBtn.querySelector('.hint').textContent = ok ? 'copiato ‚úÖ' : 'seleziona manualmente';
      setTimeout(()=> copyLinkBtn.querySelector('.hint').textContent = 'con saldo', 1600);
    });

    function setTag(status){
      tagStatus.classList.remove('good','bad','warn');
      let t=''; let cls='warn';
      if(status==='active'){ t='Attiva'; cls='good'; }
      else if(status==='partial'){ t='Parziale'; cls='warn'; }
      else if(status==='used'){ t='Usata'; cls='bad'; }
      else { t='‚Äî'; cls='warn'; }
      tagStatus.classList.add(cls);
      tagTxt.textContent = t;
      tagStatus.querySelector('.s').style.background = (cls==='good') ? 'var(--good)' : (cls==='bad' ? 'var(--bad)' : 'var(--warn)');
    }

    function renderNotFound(){
      subtitle.textContent = 'Codice non trovato o non valido.';
      gcSub.innerHTML = `Se hai ricevuto questo link, verifica che il parametro <span class="mono">code</span> sia corretto.`;
      setChipState('bad', 'Codice non valido');
      gcStatusTxt.textContent = 'Non valida';
      balance.textContent = '‚Äî';
      initValue.textContent = '‚Äî';
      setTag('');
      rows.innerHTML = '';
      rowsHint.textContent = '0 movimenti';
      movChip.innerHTML = `<b>Totale:</b> 0`;
      empty.style.display = 'block';
    }

    function render(gc, item){
      const st = String(gc.status||'active');
      const isActive = st==='active' || st==='partial';
      subtitle.textContent = 'Saldo e movimenti aggiornati.';
      setChipState(isActive ? 'good' : 'bad', (st==='active'?'Attiva':st==='partial'?'Parziale':'Usata'));
      gcStatusTxt.textContent = (st==='active'?'Attiva':st==='partial'?'Parziale':'Usata');

      const bal = Number(gc.balance ?? gc.initialValue ?? 0) || 0;
      const init = Number(gc.initialValue ?? bal) || 0;

      balance.textContent = money(bal);
      initValue.textContent = money(init);

      codeLine.textContent = `CODE: ${gc.code || code}`;
      createdLine.textContent = `‚Ä¢ Attivata: ${fmtDate(gc.createdAt || item?.createdAt)}`;

      setTag(st);

      // Customer info (if present)
      custName.textContent = (item?.name || '‚Äî');
      custPhone.textContent = item?.phone ? ('+39 ' + String(item.phone).replace(/\D/g,'')) : '‚Äî';

      // WhatsApp button: prefilled
      waBtn.href = walink(`Ciao, ho una Gift Card Re Long.\nCodice: ${gc.code || code}\nSaldo: ${money(bal)}\nMi dai supporto?`);

      // Movements
      const hist = Array.isArray(gc.history) ? gc.history : [];
      movChip.innerHTML = `<b>Totale:</b> ${hist.length}`;
      rowsHint.textContent = `${hist.length} movimento${hist.length===1?'':'i'}`;

      rows.innerHTML = '';
      if(hist.length===0){
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      // newest first
      const sorted = [...hist].sort((a,b)=> new Date(b.at||0) - new Date(a.at||0));
      sorted.forEach(m=>{
        const delta = Number(m.delta||0) || 0;
        const after = (m.balanceAfter!=null) ? Number(m.balanceAfter) : null;
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div class="left">
            <div class="t">${escapeHtml(String(m.label||'Movimento'))}</div>
            <div class="d">${fmtDate(m.at)} ‚Ä¢ ${escapeHtml(String(m.code||'GC'))}</div>
          </div>
          <div class="right">
            <div class="delta ${delta>=0?'pos':'neg'}">${delta>=0?'+':''}${money(delta).replace('‚Ç¨','‚Ç¨ ')}</div>
            <div class="bal">${after!=null ? ('Saldo: ' + money(after)) : ''}</div>
          </div>
        `;
        rows.appendChild(row);
      });
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }

    async function load(){
      if(!code){
        setChipState('warn', 'Inserisci il codice nel link');
        gcStatusTxt.textContent = 'In attesa';
        gcSub.innerHTML = `Esempio: <span class="mono">...?code=RL-XXXX-YYYY</span>`;
        rowsHint.textContent = '‚Äî';
        empty.style.display = 'block';
        return;
      }
      setChipState('warn', 'Caricamento‚Ä¶');
      gcStatusTxt.textContent = 'Caricamento';

      try{
        const res = await fetch(rawUrl, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error('Formato dati non valido');
        // find gift card by code
        let found=null, foundItem=null;
        for(const it of data){
          const gc = it && it.giftCard ? it.giftCard : null;
          if(gc && String(gc.code||'').trim().toUpperCase() === code.toUpperCase()){
            found = gc; foundItem = it; break;
          }
        }
        if(!found){
          renderNotFound();
          return;
        }
        render(found, foundItem);
      }catch(e){
        subtitle.textContent = 'Errore caricamento dati.';
        setChipState('bad', 'Errore dati');
        gcStatusTxt.textContent = 'Errore';
        gcSub.innerHTML = `Non riesco a leggere i dati in questo momento.\n<br><span class="mono">${rawUrl}</span>`;
        empty.style.display='block';
      }
    }

    load();
  })();
  </script>
</body>
</html>